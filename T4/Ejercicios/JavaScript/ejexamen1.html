<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Examen DAW 1: Analytics Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        .error {
            color: red;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="card">
        <h2>Ejercicio 1: Agrupación y Saneamiento de Datos</h2>
        <p>Genera un reporte que agrupe ventas por <strong>Categoría</strong>. Calcula: Total Ventas, Ticket Medio y el
            producto más vendido.</p>

        <textarea id="inputData">
[
  {"id": 1, "prod": "Laptop", "cat": "Tech", "price": "1200", "date": "2023-01-15"},
  {"id": 2, "prod": "Mouse", "cat": "Tech", "price": 25, "date": "2023-02-10"},
  {"id": 3, "prod": "Café", "cat": "Food", "price": "5.50", "date": "2023-01-11"},
  {"id": 4, "prod": "Monitor", "cat": "Tech", "price": 300, "date": "2023-03-01"},
  {"id": 5, "prod": "Pan", "cat": "Food", "price": "null", "date": "2023-02-20"}, 
  {"id": 6, "prod": "Laptop", "cat": "Tech", "price": 1200, "date": "2023-04-05"}
]</textarea>
        <button onclick="generarReporte()">Generar Reporte KPI</button>
        <div id="output"></div>
    </div>

    <script>
        function generarReporte() {
            try {
                const rawData = JSON.parse(document.getElementById('inputData').value);

                // 1. SANEAMIENTO Y NORMALIZACIÓN
                const cleanData = rawData
                    .map(item => ({
                        ...item,
                        price: parseFloat(item.price), // Convertir string a float
                        date: new Date(item.date)
                    }))
                    .filter(item => !isNaN(item.price) && item.price > 0 && !isNaN(item.date.getTime()));

                // 2. AGRUPACIÓN (REDUCE AVANZADO)
                const reporte = cleanData.reduce((acc, item) => {
                    const cat = item.cat;

                    if (!acc[cat]) {
                        acc[cat] = {
                            totalIngresos: 0,
                            conteoVentas: 0,
                            productos: {}, // Para calcular la moda (producto más vendido)
                            ticketMedio: 0,
                            bestSeller: ''
                        };
                    }

                    // Acumuladores
                    acc[cat].totalIngresos += item.price;
                    acc[cat].conteoVentas++;

                    // Conteo para moda
                    acc[cat].productos[item.prod] = (acc[cat].productos[item.prod] || 0) + 1;

                    return acc;
                }, {});

                // 3. CÁLCULOS FINALES (Ticket Medio y Moda)
                Object.keys(reporte).forEach(cat => {
                    const data = reporte[cat];

                    // Ticket medio
                    data.ticketMedio = data.totalIngresos / data.conteoVentas;

                    // Encontrar Best Seller (Algoritmo de búsqueda de máximo)
                    let maxVentas = 0;
                    let topProd = '';
                    for (const [prod, count] of Object.entries(data.productos)) {
                        if (count > maxVentas) {
                            maxVentas = count;
                            topProd = prod;
                        }
                    }
                    data.bestSeller = topProd;

                    // Limpieza del objeto interno auxiliar
                    delete data.productos;
                });

                renderizarTabla(reporte);

            } catch (e) {
                document.getElementById('output').innerHTML = `<p class="error">Error de parseo: ${e.message}</p>`;
            }
        }

        function renderizarTabla(datos) {
            let html = `<table><thead><tr><th>Categoría</th><th>Ingresos</th><th>Ventas</th><th>Ticket Medio</th><th>Best Seller</th></tr></thead><tbody>`;

            for (const cat in datos) {
                const fila = datos[cat];
                html += `<tr>
                    <td>${cat}</td>
                    <td>${fila.totalIngresos.toFixed(2)}€</td>
                    <td>${fila.conteoVentas}</td>
                    <td>${fila.ticketMedio.toFixed(2)}€</td>
                    <td><strong>${fila.bestSeller}</strong></td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('output').innerHTML = html;
        }
    </script>
</body>

</html>